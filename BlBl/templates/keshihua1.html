{% extends 'base.html' %}
{% load static %}
{% block title %}è¶‹åŠ¿åˆ†æ - Bç«™è§†é¢‘æ•°æ®åˆ†æå¯è§†åŒ–ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="main-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <header class="page-header">
        <h1>è¶‹åŠ¿åˆ†æ</h1>
        <p class="lead">æ·±å…¥åˆ†æè§†é¢‘æ•°æ®çš„æ—¶é—´è¶‹åŠ¿å’Œå…³è”æ€§</p>
        
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'index' %}">é¦–é¡µ</a></li>
                <li class="breadcrumb-item active" aria-current="page">è¶‹åŠ¿åˆ†æ</li>
            </ol>
        </nav>
    </header>
    
    <!-- æ•°æ®ç­›é€‰åŒº -->
    <!-- ä¿®æ”¹ç­›é€‰è¡¨å•éƒ¨åˆ† -->
<div class="row g-3">
    <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
    <div class="col-md-4">
        <label for="timeRange" class="form-label">æ—¶é—´èŒƒå›´</label>
        <select id="timeRange" class="form-select filter-select">
            <option value="all">å…¨éƒ¨æ—¶é—´</option>
            <option value="month">è¿‘ä¸€ä¸ªæœˆ</option>
            <option value="halfyear" selected>è¿‘åŠå¹´</option>
            <option value="year">è¿‘ä¸€å¹´</option>
        </select>
    </div>
    
    <!-- æ•°æ®ç»´åº¦ç­›é€‰ -->
    <div class="col-md-4">
        <label for="dataType" class="form-label">æ•°æ®ç»´åº¦</label>
        <select id="dataType" class="form-select filter-select">
            <option value="comments" selected>è¯„è®ºæ•°</option>
            <option value="likes">ç‚¹èµæ•°</option>
            <option value="favorites">æ”¶è—æ•°</option>
            <option value="damaku">å¼¹å¹•æ•°</option>
        </select>
    </div>
    
    <!-- è§†é¢‘ç±»å‹ç­›é€‰ -->
    <div class="col-md-4">
        <label for="videoType" class="form-label">è§†é¢‘ç±»å‹</label>
        <select id="videoType" class="form-select filter-select">
            <option value="all" selected>å…¨éƒ¨ç±»å‹</option>
            {% for type in video_types %}
                <option value="{{ type }}">{{ type }}</option>
            {% endfor %}
        </select>
    </div>
    
    <!-- ç±»åˆ«ç­›é€‰ -->
    <div class="col-md-4">
        <label for="category" class="form-label">è§†é¢‘ç±»åˆ«</label>
        <select id="category" class="form-select filter-select">
            <option value="all" selected>å…¨éƒ¨ç±»åˆ«</option>
            {% for cat in categories %}
                <option value="{{ cat }}">{{ cat }}</option>
            {% endfor %}
        </select>
    </div>
    
    <!-- ç­›é€‰æŒ‰é’® -->
    <div class="col-md-4 d-flex align-items-end">
        <button id="applyFilter" class="btn btn-primary w-100">
            <i class="bi bi-filter"></i> åº”ç”¨ç­›é€‰
        </button>
    </div>
</div>
<!-- åœ¨ç­›é€‰è¡¨å•ä¸‹é¢æ·»åŠ çŠ¶æ€æ˜¾ç¤º -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info d-flex align-items-center justify-content-between">
            <div>
                <i class="bi bi-info-circle me-2"></i>
                å½“å‰æ•°æ®ç»Ÿè®¡: å…± <span id="dataCount" class="fw-bold">{{ data_count|default:0 }}</span> æ¡è®°å½•
            </div>
            <div id="filterStatus" class="text-muted small">
                å·²åº”ç”¨ç­›é€‰: æ—¶é—´èŒƒå›´-å…¨éƒ¨, æ•°æ®ç»´åº¦-è¯„è®ºæ•°, ç±»å‹-å…¨éƒ¨, ç±»åˆ«-å…¨éƒ¨
            </div>
        </div>
    </div>
</div>

    <!-- åŠŸèƒ½æ¦‚è§ˆåŒº -->
    <section class="row mb-5">
        <div class="col-md-4 mb-4">
            <div class="card feature-card h-100">
                <div class="card-body p-4">
                    <div class="card-icon duration-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-clock" viewBox="0 0 16 16">
                            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                        </svg>
                    </div>
                    <h5 class="card-title">æ—¶é•¿åˆ†æ</h5>
                    <p class="card-text">åˆ†æè§†é¢‘æ—¶é•¿ä¸ç”¨æˆ·äº’åŠ¨ï¼ˆå¦‚ç‚¹èµï¼‰çš„å…³ç³»ï¼Œä¸ºè§†é¢‘åˆ›ä½œæä¾›æ—¶é•¿å»ºè®®ã€‚</p>
                    <a href="#durationLikesChart" class="btn btn-sm btn-outline-primary mt-2 scroll-to-chart">æŸ¥çœ‹è¯¦æƒ…</a>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card feature-card h-100">
                <div class="card-body p-4">
                    <div class="card-icon monthly-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-calendar-month" viewBox="0 0 16 16">
                            <path d="M2.56 11.332 3.1 9.73h1.984l.54 1.602h.718L4.444 6h-.696L1.85 11.332h.71zm1.544-4.527L4.9 9.18H3.284l.8-2.375h.02zm5.746.422h-.676V9.77c0 .652-.414 1.023-1.004 1.023-.539 0-.98-.246-.98-1.012V7.227h-.676v2.746c0 .941.606 1.425 1.453 1.425.656 0 1.043-.28 1.188-.605h.027v.539h.668V7.227zm2.258 5.046c-.563 0-.91-.304-.985-.636h-.687c.094.683.625 1.199 1.668 1.199.93 0 1.746-.527 1.746-1.578V7.227h-.649v.578h-.019c-.191-.348-.637-.64-1.195-.64-.965 0-1.64.679-1.64 1.886v.34c0 1.23.683 1.902 1.64 1.902.558 0 1.008-.293 1.172-.648h.02v.605c0 .645-.423 1.023-1.071 1.023zm.008-4.53c.648 0 1.062.527 1.062 1.359v.253c0 .848-.39 1.364-1.062 1.364-.692 0-1.098-.512-1.098-1.364v-.253c0-.868.406-1.36 1.098-1.36z"/>
                        </svg>
                    </div>
                    <h5 class="card-title">æœˆåº¦è¶‹åŠ¿</h5>
                    <p class="card-text">å±•ç¤ºè§†é¢‘å‘å¸ƒå’Œç”¨æˆ·äº’åŠ¨ï¼ˆå¦‚è¯„è®ºï¼‰çš„æœˆåº¦å˜åŒ–ï¼Œè¯†åˆ«ç”¨æˆ·äº’åŠ¨å­£èŠ‚æ€§è§„å¾‹ã€‚</p>
                    <a href="#monthlyCommentsChart" class="btn btn-sm btn-outline-primary mt-2 scroll-to-chart">æŸ¥çœ‹è¯¦æƒ…</a>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card feature-card h-100">
                <div class="card-body p-4">
                    <div class="card-icon correlation-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-link-45deg" viewBox="0 0 16 16">
                            <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
                            <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/>
                        </svg>
                    </div>
                    <h5 class="card-title">ç›¸å…³æ€§åˆ†æ</h5>
                    <p class="card-text">å‘ç°ä¸åŒæ•°æ®æŒ‡æ ‡ä¹‹é—´çš„æ½œåœ¨å…³è”ï¼Œå¸®åŠ©ç†è§£å½±å“è§†é¢‘è¡¨ç°çš„å…³é”®å› ç´ ã€‚</p>
                    <a href="#combinedTrendChart" class="btn btn-sm btn-outline-primary mt-2 scroll-to-chart">æŸ¥çœ‹è¯¦æƒ…</a>
                </div>
            </div>
        </div>
    </section>
    
    <!-- å¯è§†åŒ–å›¾è¡¨åŒº -->
    <section class="row">
        <!-- å›¾è¡¨1ï¼šè§†é¢‘æ—¶é•¿ä¸ç‚¹èµæ•°å…³ç³»åˆ†æ -->
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3 class="chart-title">è§†é¢‘æ—¶é•¿ä¸ç‚¹èµæ•°å…³ç³»åˆ†æ</h3>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-outline-secondary export-chart" data-chart-id="durationLikesChart">
                                <i class="bi bi-download"></i> å¯¼å‡º
                            </button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <div id="durationLikesChart">
                            <div class="loading-container">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="insight-box">
                        <div class="insight-title">ğŸ“ˆ æ•°æ®æ´å¯Ÿ</div>
                        <p id="durationInsight">åˆ†ææ˜¾ç¤ºï¼Œæ—¶é•¿åœ¨5-15åˆ†é’Ÿçš„è§†é¢‘è·å¾—ç‚¹èµæ•°çš„ä¸­ä½æ•°æœ€é«˜ã€‚è¿‡çŸ­ï¼ˆ&lt;3åˆ†é’Ÿï¼‰å’Œè¿‡é•¿ï¼ˆ&gt;30åˆ†é’Ÿï¼‰çš„è§†é¢‘ç‚¹èµæ•°ç›¸å¯¹è¾ƒä½ã€‚å»ºè®®åˆ›ä½œè€…å°†è§†é¢‘æ—¶é•¿æ§åˆ¶åœ¨8-12åˆ†é’ŸèŒƒå›´å†…ä»¥è·å¾—æœ€ä½³äº’åŠ¨æ•ˆæœã€‚</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å›¾è¡¨2ï¼šæœˆåº¦è¯„è®ºè¶‹åŠ¿ -->
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3 class="chart-title">æœˆåº¦è¯„è®ºè¶‹åŠ¿</h3>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-outline-secondary export-chart" data-chart-id="monthlyCommentsChart">
                                <i class="bi bi-download"></i> å¯¼å‡º
                            </button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <div id="monthlyCommentsChart">
                            <div class="loading-container">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="insight-box">
                        <div class="insight-title">ğŸ“… å­£èŠ‚æ€§è§„å¾‹</div>
                        <p id="commentsInsight">ç”¨æˆ·è¯„è®ºåœ¨å¯’æš‘å‡æœŸé—´ï¼ˆ7-8æœˆï¼Œ1-2æœˆï¼‰è¾¾åˆ°é«˜å³°ï¼Œè€Œåœ¨å­¦æœŸä¸­ï¼ˆ3-6æœˆï¼Œ9-12æœˆï¼‰ç›¸å¯¹å¹³ç¨³ã€‚å»ºè®®åœ¨å‡æœŸæœŸé—´å¢åŠ äº’åŠ¨æ€§å†…å®¹ä»¥åˆ©ç”¨ç”¨æˆ·æ´»è·ƒæœŸã€‚</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å›¾è¡¨3ï¼šæœˆåº¦è§†é¢‘å‘å¸ƒé‡ -->
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3 class="chart-title">æœˆåº¦è§†é¢‘å‘å¸ƒé‡</h3>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-outline-secondary export-chart" data-chart-id="monthlyVideosChart">
                                <i class="bi bi-download"></i> å¯¼å‡º
                            </button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <div id="monthlyVideosChart">
                            <div class="loading-container">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="insight-box">
                        <div class="insight-title">ğŸ¬ å‘å¸ƒè§„å¾‹</div>
                        <p id="videosInsight">è§†é¢‘å‘å¸ƒåœ¨å¹´æœ«ï¼ˆ11-12æœˆï¼‰å’Œå¹´ä¸­ï¼ˆ6-7æœˆï¼‰æœ‰æ˜æ˜¾å¢é•¿ï¼Œå¯èƒ½ä¸åˆ›ä½œè€…å†²åˆºå¹´åº¦ç›®æ ‡æˆ–åˆ©ç”¨å‡æœŸæ—¶é—´æœ‰å…³ã€‚2æœˆä»½å‘å¸ƒé‡æœ€ä½ï¼Œå¯èƒ½ä¸æ˜¥èŠ‚å‡æœŸç›¸å…³ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å›¾è¡¨4ï¼šç»„åˆè¶‹åŠ¿å›¾ -->
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3 class="chart-title">ç»„åˆè¶‹åŠ¿å›¾ï¼šå‘å¸ƒä¸äº’åŠ¨å¯¹æ¯”</h3>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-outline-secondary export-chart" data-chart-id="combinedTrendChart">
                                <i class="bi bi-download"></i> å¯¼å‡º
                            </button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <div id="combinedTrendChart">
                            <div class="loading-container">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="insight-box">
                        <div class="insight-title">ğŸ” è¶‹åŠ¿å¯¹æ¯”</div>
                        <p id="combinedInsight">è§†é¢‘å‘å¸ƒé‡ä¸ç”¨æˆ·è¯„è®ºæ•°å­˜åœ¨æ­£ç›¸å…³å…³ç³»ï¼Œä½†ç‚¹èµç‡ï¼ˆç‚¹èµæ•°/å‘å¸ƒé‡ï¼‰åœ¨å‘å¸ƒé‡è¾ƒä½çš„æœˆä»½åè€Œæ›´é«˜ï¼Œè¡¨æ˜å†…å®¹è´¨é‡æ¯”æ•°é‡æ›´å½±å“ç”¨æˆ·äº’åŠ¨ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- æ•°æ®ä¸‹è½½åŒº -->
    <section class="data-download-section mb-5">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">æ•°æ®å¯¼å‡º</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p class="mb-0">æ‚¨å¯ä»¥å¯¼å‡ºå½“å‰åˆ†æçš„åŸå§‹æ•°æ®ï¼Œç”¨äºè¿›ä¸€æ­¥çš„ç¦»çº¿åˆ†æå’ŒæŠ¥å‘Šåˆ¶ä½œã€‚</p>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button id="exportExcel" class="btn btn-success">
                                <i class="bi bi-file-excel"></i> å¯¼å‡ºExcel
                            </button>
                            <button id="exportCSV" class="btn btn-info">
                                <i class="bi bi-file-text"></i> å¯¼å‡ºCSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- é¡µé¢å¯¼èˆª -->
    <section class="page-navigation">
        <a href="{% url 'keshihua' %}" class="nav-btn btn-prev">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            åŸºç¡€å¯è§†åŒ–åˆ†æ
        </a>
        <a href="{% url 'wordcloud' %}" class="nav-btn btn-next">
            è¯äº‘åˆ†æ
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
            </svg>
        </a>
    </section>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --accent-color: #4d7cfe;
        --success-color: #52c494;
        --danger-color: #ff6b6b;
        --warning-color: #ffc107;
        --info-color: #56c5ff;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
    }
    
    .main-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .page-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px 0;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        border-radius: 15px;
        color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        position: relative;
        overflow: hidden;
    }
    
    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        opacity: 0.3;
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        position: relative;
        z-index: 1;
    }
    
    .page-header .lead {
        font-size: 1.1rem;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
        color: whitesmoke;
    }
    
    .breadcrumb {
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 8px 20px;
        display: inline-block;
        margin-top: 20px;
        position: relative;
        z-index: 1;
        backdrop-filter: blur(5px);
    }
    
    .breadcrumb-item a {
        color: white;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .breadcrumb-item a:hover {
        color: #e3e7ff;
        text-decoration: underline;
    }
    
    .breadcrumb-item.active {
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* ç­›é€‰åŒºæ ·å¼ */
    .filter-section {
        margin-bottom: 30px;
    }
    
    .filter-card {
        border: 1px solid #eaeaea;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        background: white;
    }
    
    /* åŠŸèƒ½å¡ç‰‡æ ·å¼ */
    .feature-card {
        border: none;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        height: 100%;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        background: white;
        position: relative;
        overflow: hidden;
    }
    
    .feature-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        opacity: 0.8;
    }
    
    .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .feature-card:hover::before {
        opacity: 1;
    }
    
    .card-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .feature-card:hover .card-icon {
        transform: scale(1.05);
    }
    
    .duration-icon {
        background-color: rgba(86, 197, 255, 0.15);
        color: var(--info-color);
    }
    
    .monthly-icon {
        background-color: rgba(255, 107, 107, 0.15);
        color: var(--danger-color);
    }
    
    .correlation-icon {
        background-color: rgba(82, 196, 148, 0.15);
        color: var(--success-color);
    }
    
    /* å›¾è¡¨å®¹å™¨æ ·å¼ */
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid #eaeaea;
        height: 550px;
        transition: all 0.3s ease;
    }
    
    .chart-container:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .chart-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--dark-color);
        margin: 0;
    }
    
    .chart-actions {
        display: flex;
        gap: 8px;
    }
    
    .insight-box {
        background-color: #f8f9ff;
        border-left: 4px solid var(--accent-color);
        padding: 15px;
        border-radius: 0 8px 8px 0;
        margin-top: 20px;
        transition: all 0.3s ease;
    }
    
    .chart-container:hover .insight-box {
        background-color: #f0f4ff;
    }
    
    .insight-title {
        font-weight: 600;
        color: var(--accent-color);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* é¡µé¢å¯¼èˆªæ ·å¼ */
    .page-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 50px;
        padding-top: 30px;
        border-top: 1px solid #eaeaea;
    }
    
    .nav-btn {
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .btn-prev {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-prev:hover {
        background-color: #5a6268;
        color: white;
        transform: translateX(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .btn-next {
        background-color: var(--accent-color);
        color: white;
    }
    
    .btn-next:hover {
        background-color: #3a66e0;
        color: white;
        transform: translateX(3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .chart-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .chart-content {
        flex: 1;
        min-height: 0;
        position: relative;
    }
    
    #durationLikesChart, #monthlyCommentsChart, #monthlyVideosChart, #combinedTrendChart {
        width: 100%;
        height: 100%;
    }
    
    /* æ•°æ®ä¸‹è½½åŒºæ ·å¼ */
    .data-download-section {
        margin-top: 20px;
    }
    
    /* åŠ è½½åŠ¨ç”»æ ·å¼ */
    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        flex-direction: column;
        gap: 15px;
    }
    
    .loading-container p {
        color: #666;
        margin: 0;
        font-size: 14px;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.4em;
    }
    
    /* å“åº”å¼æ ·å¼ */
    @media (max-width: 992px) {
        .chart-container {
            height: 480px;
        }
    }
    
    @media (max-width: 768px) {
        .chart-container {
            height: 420px;
            padding: 15px;
        }
        
        .page-header h1 {
            font-size: 2rem;
        }
        
        .page-navigation {
            flex-direction: column;
            gap: 15px;
        }
        
        .nav-btn {
            width: 100%;
            justify-content: center;
        }
        
        .filter-section .row {
            flex-direction: column;
        }
        
        .filter-section .col-md-3 {
            margin-bottom: 15px !important;
        }
    }
    
    @media (max-width: 576px) {
        .chart-container {
            height: 380px;
        }
        
        .main-container {
            padding: 10px;
        }
        
        .chart-title {
            font-size: 1.2rem;
        }
    }
    
    /* å¹³æ»‘æ»šåŠ¨ */
    html {
        scroll-behavior: smooth;
    }
    
    /* å¯¼å‡ºæŒ‰é’®æ ·å¼ */
    .export-chart {
        transition: all 0.2s ease;
    }
    
    .export-chart:hover {
        background-color: #e9ecef;
        color: #495057;
    }
    
    /* å›¾è¡¨æ•°æ®ä¸ºç©ºæ—¶çš„æ ·å¼ */
    .chart-empty {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #666;
        text-align: center;
        padding: 20px;
    }
    
    .chart-empty i {
        font-size: 48px;
        color: #ccc;
        margin-bottom: 15px;
    }
    
    /* æ»šåŠ¨åˆ°å›¾è¡¨çš„åŠ¨ç”» */
    .scroll-to-chart {
        transition: all 0.2s ease;
    }
    
    .scroll-to-chart:hover {
        background-color: var(--primary-color);
        color: white !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    // è°ƒè¯•ä¿¡æ¯
    console.log('åŸå§‹æ•°æ®:', {
        videoDurationData: {{ video_duration_data|safe }},
        publishMonthData: {{ publish_month_data|safe }},
        videoCountData: {{ video_count_data|safe }}
    });
    
    // ç›´æ¥è§£æJSONæ•°æ®
    let videoDurationData, publishMonthData, videoCountData;
    
    try {
        videoDurationData = {{ video_duration_data|safe }};
        publishMonthData = {{ publish_month_data|safe }};
        videoCountData = {{ video_count_data|safe }};
        
        console.log('è§£æåçš„æ•°æ®:', {
            videoDurationData: videoDurationData,
            publishMonthData: publishMonthData,
            videoCountData: videoCountData
        });
    } catch (error) {
        console.error('æ•°æ®è§£æé”™è¯¯:', error);
        // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºå¤‡ç”¨
        videoDurationData = [
            [1, 1200], [2, 1800], [3, 2500], [4, 3200], [5, 4500],
            [8, 6800], [10, 7500], [12, 7200], [15, 6500], [20, 5200],
            [25, 4100], [30, 3200], [35, 2800], [40, 2100]
        ];
        publishMonthData = [4500, 5200, 3800, 3600, 3900, 4100, 6800, 7200, 4200, 4000, 4800, 5100];
        videoCountData = [280, 210, 320, 350, 380, 420, 450, 410, 390, 370, 480, 520];
    }
    // å·¥å…·å‡½æ•°
    function getDataTypeText(dataType) {
        const dataTypeMap = {
            'comments': 'è¯„è®ºæ•°',
            'likes': 'ç‚¹èµæ•°',
            'favorites': 'æ”¶è—æ•°',
            'damaku': 'å¼¹å¹•æ•°'
        };
        return dataTypeMap[dataType] || 'è¯„è®ºæ•°';
    }
    function getTimeRangeText(timeRange) {
        const timeRangeMap = {
            'all': 'å…¨éƒ¨æ—¶é—´',
            'month': 'è¿‘ä¸€ä¸ªæœˆ',
            'halfyear': 'è¿‘åŠå¹´',
            'year': 'è¿‘ä¸€å¹´'
        };
        return timeRangeMap[timeRange] || 'å…¨éƒ¨æ—¶é—´';
    }
    // åŠ è½½çŠ¶æ€å‡½æ•°
    function showLoadingState() {
        console.log('æ˜¾ç¤ºåŠ è½½çŠ¶æ€');
        const charts = document.querySelectorAll('.echarts');
        charts.forEach(chart => {
            if (chart && !chart.querySelector('.loading-container')) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-container';
                loadingDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span></div>';
                chart.appendChild(loadingDiv);
            }
        });
        
        const applyBtn = document.getElementById('applyFilter');
        if (applyBtn) {
            applyBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ç­›é€‰ä¸­...';
            applyBtn.disabled = true;
        }
    }
    
    function hideLoadingState() {
        console.log('éšè—åŠ è½½çŠ¶æ€');
        const loadingContainers = document.querySelectorAll('.loading-container');
        loadingContainers.forEach(container => {
            container.remove();
        });
        
        const applyBtn = document.getElementById('applyFilter');
        if (applyBtn) {
            applyBtn.innerHTML = '<i class="bi bi-filter"></i> åº”ç”¨ç­›é€‰';
            applyBtn.disabled = false;
        }
    }
    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'success') {
        // ç§»é™¤ç°æœ‰é€šçŸ¥
        const existingNotifications = document.querySelectorAll('.custom-notification');
        existingNotifications.forEach(notification => {
            notification.remove();
        });
        
        // åˆ›å»ºæ–°é€šçŸ¥
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : 'success'} custom-notification position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        notification.innerHTML = `
            <i class="bi ${type === 'error' ? 'bi-x-circle' : 'bi-check-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        
        document.body.appendChild(notification);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
    
    // ç¡®ä¿æ•°æ®æ˜¯æ•°ç»„æ ¼å¼
    const safeDurationData = Array.isArray(videoDurationData) ? videoDurationData : [];
    const safeCommentsData = Array.isArray(publishMonthData) ? publishMonthData : [];
    const safeVideoCountData = Array.isArray(videoCountData) ? videoCountData : [];
    
    console.log('æœ€ç»ˆä½¿ç”¨çš„æ•°æ®:', {
        durationDataLength: safeDurationData.length,
        commentsData: safeCommentsData,
        videoCountData: safeVideoCountData
    });
    
    // å…¨å±€å›¾è¡¨å®ä¾‹
    let chartInstances = {};
    
    // æœˆä»½æ ‡ç­¾
    const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
    
     // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–å›¾è¡¨');
        
        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
        setTimeout(() => {
            initCharts();
        }, 100);
        
        // ç»‘å®šäº‹ä»¶
        bindEvents();
    });
    
    // ç»‘å®šæ‰€æœ‰äº‹ä»¶
    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // ç­›é€‰æŒ‰é’®äº‹ä»¶
        const applyFilterBtn = document.getElementById('applyFilter');
        if (applyFilterBtn) {
            console.log('ç»‘å®šç­›é€‰æŒ‰é’®äº‹ä»¶');
            applyFilterBtn.addEventListener('click', applyFilters);
        } else {
            console.error('æ‰¾ä¸åˆ°ç­›é€‰æŒ‰é’®');
        }
        
        // ä¸‹æ‹‰æ¡†å˜åŒ–äº‹ä»¶
        document.querySelectorAll('.filter-select').forEach(select => {
            select.addEventListener('change', function() {
                console.log('ç­›é€‰æ¡ä»¶å˜åŒ–:', this.id, this.value);
            });
        });
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
        
        // åˆå§‹åŒ–å›¾è¡¨
        initCharts();
        
        // ç»‘å®šäº‹ä»¶
        bindEvents();
        
        // åˆå§‹åŒ–ç­›é€‰çŠ¶æ€
        const timeRange = document.getElementById('timeRange')?.value || 'all';
        const dataType = document.getElementById('dataType')?.value || 'comments';
        const videoType = document.getElementById('videoType')?.value || 'all';
        const category = document.getElementById('category')?.value || 'all';
        updateFilterStatus(timeRange, dataType, videoType, category);
    });
    
    
   // æ£€æŸ¥æ•°æ®
    function checkData() {
        const hasDurationData = videoDurationData && videoDurationData.length > 0;
        const hasCommentsData = publishMonthData && publishMonthData.length === 12;
        const hasVideoCountData = videoCountData && videoCountData.length === 12;
        
        console.log('æ•°æ®æ£€æŸ¥:', {
            hasDurationData,
            hasCommentsData,
            hasVideoCountData
        });
        
        return hasDurationData && hasCommentsData && hasVideoCountData;
    }
    
    // åˆå§‹åŒ–å›¾è¡¨
    function initCharts() {
        console.log('å¼€å§‹åˆå§‹åŒ–å›¾è¡¨');
        
        if (!checkData()) {
            console.error('æ•°æ®æ£€æŸ¥å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯');
            return;
        }
        
        try {
            renderDurationLikesChart();
            console.log('å›¾è¡¨1åˆå§‹åŒ–å®Œæˆ');
            
            renderMonthlyCommentsChart();
            console.log('å›¾è¡¨2åˆå§‹åŒ–å®Œæˆ');
            
            renderMonthlyVideosChart();
            console.log('å›¾è¡¨3åˆå§‹åŒ–å®Œæˆ');
            
            renderCombinedTrendChart();
            console.log('å›¾è¡¨4åˆå§‹åŒ–å®Œæˆ');
            
            console.log('æ‰€æœ‰å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
            
        } catch (error) {
            console.error('å›¾è¡¨åˆå§‹åŒ–é”™è¯¯:', error);
        }
    }
    
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showErrorMessages() {
        const chartContainers = document.querySelectorAll('.chart-content > div[id$="Chart"]');
        chartContainers.forEach(container => {
            if (container.querySelector('.loading-container')) {
                container.innerHTML = `
                    <div class="chart-empty">
                        <i class="bi bi-database-x"></i>
                        <h5>æ•°æ®åŠ è½½å¤±è´¥</h5>
                        <p>æ— æ³•åŠ è½½å›¾è¡¨æ•°æ®ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼æˆ–åˆ·æ–°é¡µé¢</p>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="location.reload()">
                            <i class="bi bi-arrow-repeat"></i> åˆ·æ–°é¡µé¢
                        </button>
                    </div>
                `;
            }
        });
    }
    
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showErrorMessages() {
        const chartContainers = document.querySelectorAll('.chart-content > div[id$="Chart"]');
        chartContainers.forEach(container => {
            container.innerHTML = `
                <div class="chart-empty">
                    <i class="bi bi-database-x"></i>
                    <h5>æš‚æ— æ•°æ®</h5>
                    <p>æ— æ³•åŠ è½½å›¾è¡¨æ•°æ®ï¼Œè¯·ç¨åé‡è¯•</p>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="window.location.reload()">
                        <i class="bi bi-arrow-repeat"></i> åˆ·æ–°é¡µé¢
                    </button>
                </div>
            `;
        });
    }
    
   // ç§»é™¤åŠ è½½åŠ¨ç”»
    function removeLoadingAnimations() {
        const loadingContainers = document.querySelectorAll('.loading-container');
        loadingContainers.forEach(container => {
            container.remove();
        });
    }
    
    // åœ¨æ¸²æŸ“å›¾è¡¨æ—¶ï¼Œæ ¹æ®æ•°æ®ç±»å‹æ›´æ–°æ ‡é¢˜
function renderDurationLikesChart() {
        const chartDom = document.getElementById('durationLikesChart');
        if (!chartDom) {
            console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨: durationLikesChart');
            return;
        }
        
        const myChart = echarts.init(chartDom);
        chartInstances.durationLikesChart = myChart;
        
        // è·å–å½“å‰æ•°æ®ç±»å‹
        const dataType = document.getElementById('dataType')?.value || 'comments';
        const dataTypeText = getDataTypeText(dataType);
        
        // å¯¹å¤§æ•°æ®è¿›è¡ŒæŠ½æ ·æ˜¾ç¤º
        let displayData = videoDurationData;
        if (videoDurationData.length > 1000) {
            displayData = [];
            const step = Math.floor(videoDurationData.length / 1000);
            for (let i = 0; i < videoDurationData.length; i += step) {
                if (i < videoDurationData.length) {
                    displayData.push(videoDurationData[i]);
                }
                if (displayData.length >= 1000) break;
            }
        }
        
        const scatterData = displayData.map(item => ({
            value: [item[0], item[1]],
            name: `${item[0]}åˆ†é’Ÿè§†é¢‘`,
            count: item[1],
            duration: item[0]
        }));
        
        const option = {
            title: {
                text: `è§†é¢‘æ—¶é•¿ä¸${dataTypeText}å…³ç³»`,
                left: 'center',
                textStyle: { fontSize: 16, fontWeight: 'bold' }
            },
            tooltip: {
                trigger: 'item',
                formatter: params => {
                    return `${params.name}<br/>æ—¶é•¿: ${params.value[0]}åˆ†é’Ÿ<br/>${dataTypeText}: ${params.value[1].toLocaleString()}`;
                }
            },
            grid: {
                left: '8%',
                right: '7%',
                bottom: '15%',
                top: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'value',
                name: 'è§†é¢‘æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰',
                nameLocation: 'middle',
                nameGap: 35
            },
            yAxis: {
                type: 'value',
                name: dataTypeText,
                nameLocation: 'middle',
                nameGap: 50
            },
            series: [{
                name: 'è§†é¢‘æ•°æ®',
                type: 'scatter',
                symbolSize: 8,
                data: scatterData,
                itemStyle: { color: '#56c5ff' }
            }]
        };
        
        myChart.setOption(option);
        
        window.addEventListener('resize', () => myChart.resize());
    }
    
    // ç±»ä¼¼åœ°æ›´æ–°å…¶ä»–å›¾è¡¨çš„æ ‡é¢˜
function renderMonthlyCommentsChart() {
        const chartDom = document.getElementById('monthlyCommentsChart');
        if (!chartDom) return;
        
        const myChart = echarts.init(chartDom);
        chartInstances.monthlyCommentsChart = myChart;
        
        const dataType = document.getElementById('dataType')?.value || 'comments';
        const dataTypeText = getDataTypeText(dataType);
        
        const option = {
            title: {
                text: `æœˆåº¦${dataTypeText}è¶‹åŠ¿`,
                left: 'center',
                textStyle: { fontSize: 16, fontWeight: 'bold' }
            },
            tooltip: {
                trigger: 'axis',
                formatter: '{b}: {c} ' + dataTypeText
            },
            grid: {
                left: '8%',
                right: '7%',
                bottom: '15%',
                top: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: months
            },
            yAxis: {
                type: 'value',
                name: dataTypeText
            },
            series: [{
                name: dataTypeText,
                type: 'line',
                data: publishMonthData,
                lineStyle: { width: 3, color: '#ff6b6b' },
                itemStyle: { color: '#ff6b6b' }
            }]
        };
        
        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());
    }
    // æ¸²æŸ“æœˆåº¦è§†é¢‘å‘å¸ƒé‡å›¾è¡¨
    function renderMonthlyVideosChart() {
        const chartDom = document.getElementById('monthlyVideosChart');
        if (!chartDom) return;
        
        const myChart = echarts.init(chartDom);
        chartInstances.monthlyVideosChart = myChart;
        
        const option = {
            title: {
                text: 'æœˆåº¦è§†é¢‘å‘å¸ƒé‡',
                left: 'center',
                textStyle: { fontSize: 16, fontWeight: 'bold' }
            },
            tooltip: {
                trigger: 'axis',
                formatter: '{b}: {c} ä¸ªè§†é¢‘'
            },
            grid: {
                left: '8%',
                right: '7%',
                bottom: '15%',
                top: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: months
            },
            yAxis: {
                type: 'value',
                name: 'å‘å¸ƒæ•°é‡'
            },
            series: [{
                name: 'è§†é¢‘å‘å¸ƒé‡',
                type: 'bar',
                data: videoCountData,
                itemStyle: { color: '#56c5ff' }
            }]
        };
        
        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());
    }
    
    
    // æ¸²æŸ“ç»„åˆè¶‹åŠ¿å›¾
    function renderCombinedTrendChart() {
        const chartDom = document.getElementById('combinedTrendChart');
        if (!chartDom) return;
        
        console.log('å¼€å§‹æ¸²æŸ“ç»„åˆå›¾è¡¨');
        
        const myChart = echarts.init(chartDom);
        chartInstances.combinedTrendChart = myChart;
        
        const dataType = document.getElementById('dataType')?.value || 'comments';
        const dataTypeText = getDataTypeText(dataType);
        
        const option = {
            title: {
                text: `${dataTypeText}ä¸å‘å¸ƒé‡å¯¹æ¯”è¶‹åŠ¿`,
                left: 'center',
                textStyle: { fontSize: 16, fontWeight: 'bold' }
            },
            tooltip: { trigger: 'axis' },
            grid: {
                left: '8%',
                right: '10%',
                bottom: '15%',
                top: '15%',
                containLabel: true
            },
            xAxis: { type: 'category', data: months },
            yAxis: [
                { type: 'value', name: dataTypeText },
                { type: 'value', name: 'å‘å¸ƒé‡', position: 'right' }
            ],
            series: [
                {
                    name: dataTypeText,
                    type: 'line',
                    yAxisIndex: 0,
                    data: publishMonthData,
                    lineStyle: { width: 3, color: '#ff6b6b' }
                },
                {
                    name: 'å‘å¸ƒé‡',
                    type: 'line',
                    yAxisIndex: 1,
                    data: videoCountData,
                    lineStyle: { width: 3, color: '#56c5ff' }
                }
            ],
            legend: { data: [dataTypeText, 'å‘å¸ƒé‡'], right: 0, top: 0 }
        };
        
        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());
        
        console.log('ç»„åˆå›¾è¡¨æ¸²æŸ“å®Œæˆ');
    }
    
    // ç­›é€‰åŠŸèƒ½
    function applyFilters() {
        console.log('æ‰§è¡ŒapplyFilterså‡½æ•°');
        
        const timeRange = document.getElementById('timeRange').value;
        const dataType = document.getElementById('dataType').value;
        const videoType = document.getElementById('videoType').value;
        const category = document.getElementById('category').value;
        
        console.log('åº”ç”¨ç­›é€‰æ¡ä»¶:', { 
            timeRange, 
            dataType, 
            videoType, 
            category 
        });
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoadingState();
        
        // æ„å»ºæŸ¥è¯¢å‚æ•°
        const params = new URLSearchParams({
            timeRange: timeRange,
            dataType: dataType,
            videoType: videoType,
            category: category
        });
        
        // å‘é€AJAXè¯·æ±‚è·å–ç­›é€‰åçš„æ•°æ®
        fetch(`/keshihua1/?${params}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('ç½‘ç»œå“åº”é”™è¯¯: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('ç­›é€‰ç»“æœ:', data);
            
            // æ›´æ–°æ•°æ®
            videoDurationData = data.video_duration_data;
            publishMonthData = data.publish_month_data;
            videoCountData = data.video_count_data;
            
            // é‡æ–°æ¸²æŸ“å›¾è¡¨
            updateCharts();
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats(data.data_count);
            
            // æ›´æ–°ç­›é€‰çŠ¶æ€
            updateFilterStatus(timeRange, dataType, videoType, category);
            
            // éšè—åŠ è½½çŠ¶æ€
            hideLoadingState();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification(`ç­›é€‰å®Œæˆï¼Œå…± ${data.data_count} æ¡æ•°æ®`);
        })
        .catch(error => {
            console.error('ç­›é€‰è¯·æ±‚å¤±è´¥:', error);
            hideLoadingState();
            showNotification('ç­›é€‰å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        });
    }
// æ›´æ–°å›¾è¡¨
    function updateCharts() {
        console.log('æ›´æ–°æ‰€æœ‰å›¾è¡¨');
        
        if (!checkData()) {
            console.error('æ•°æ®æ£€æŸ¥å¤±è´¥ï¼Œæ— æ³•æ›´æ–°å›¾è¡¨');
            return;
        }
        
        try {
            // é”€æ¯æ‰€æœ‰ç°æœ‰å›¾è¡¨å®ä¾‹
            Object.values(chartInstances).forEach(chart => {
                if (chart && !chart.isDisposed()) {
                    chart.dispose();
                }
            });
            
            // é‡æ–°åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
            chartInstances = {};
            
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
            renderDurationLikesChart();
            renderMonthlyCommentsChart();
            renderMonthlyVideosChart();
            renderCombinedTrendChart();
            
            console.log('å›¾è¡¨æ›´æ–°å®Œæˆ');
        } catch (error) {
            console.error('å›¾è¡¨æ›´æ–°é”™è¯¯:', error);
            showNotification('å›¾è¡¨æ›´æ–°å¤±è´¥', 'error');
        }
    }
function updateStats(count) {
        const statsElement = document.getElementById('dataCount');
        if (statsElement) {
            statsElement.textContent = count.toLocaleString();
        }
    }
    // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
// æ›´æ–°ç­›é€‰çŠ¶æ€
    function updateFilterStatus(timeRange, dataType, videoType, category) {
        const statusElement = document.getElementById('filterStatus');
        if (!statusElement) return;
        
        const timeRangeText = getTimeRangeText(timeRange);
        const dataTypeText = getDataTypeText(dataType);
        const videoTypeText = videoType === 'all' ? 'å…¨éƒ¨ç±»å‹' : videoType;
        const categoryText = category === 'all' ? 'å…¨éƒ¨ç±»åˆ«' : category;
        
        statusElement.textContent = `å·²åº”ç”¨ç­›é€‰: æ—¶é—´-${timeRangeText}, ç»´åº¦-${dataTypeText}, ç±»å‹-${videoTypeText}, ç±»åˆ«-${categoryText}`;
    }
    
    // ç»‘å®šå¯¼å‡ºäº‹ä»¶
    function bindExportEvents() {
        document.querySelectorAll('.export-chart').forEach(btn => {
            btn.addEventListener('click', function() {
                const chartId = this.getAttribute('data-chart-id');
                const chartInstance = chartInstances[chartId];
                
                if (chartInstance) {
                    // å¯¼å‡ºä¸ºPNGå›¾ç‰‡
                    const dataUrl = chartInstance.getDataURL({
                        type: 'png',
                        pixelRatio: 2,
                        backgroundColor: '#fff'
                    });
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.download = `${chartId}_${new Date().getTime()}.png`;
                    link.href = dataUrl;
                    link.click();
                    
                    showNotification('å›¾è¡¨å¯¼å‡ºæˆåŠŸ', 'success');
                } else {
                    showNotification('å›¾è¡¨å¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
                }
            });
        });
    }
    
    // å¯¼å‡ºæ•°æ®åˆ°Excel
    function exportToExcel() {
        // å‡†å¤‡æ•°æ®
        const data = {
            'è§†é¢‘æ—¶é•¿ä¸ç‚¹èµæ•°': safeDurationData.map(item => ({
                'æ—¶é•¿(åˆ†é’Ÿ)': item[0],
                'ç‚¹èµæ•°': item[1]
            })),
            'æœˆåº¦è¯„è®ºè¶‹åŠ¿': months.map((month, idx) => ({
                'æœˆä»½': month,
                'è¯„è®ºæ•°': safeCommentsData[idx] || 0
            })),
            'æœˆåº¦è§†é¢‘å‘å¸ƒé‡': months.map((month, idx) => ({
                'æœˆä»½': month,
                'å‘å¸ƒé‡': safeVideoCountData[idx] || 0
            }))
        };
        
        // åˆ›å»ºå·¥ä½œç°¿
        const wb = XLSX.utils.book_new();
        
        // æ·»åŠ å·¥ä½œè¡¨
        Object.keys(data).forEach(sheetName => {
            const ws = XLSX.utils.json_to_sheet(data[sheetName]);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        });
        
        // å¯¼å‡ºæ–‡ä»¶
        XLSX.writeFile(wb, `Bç«™è§†é¢‘è¶‹åŠ¿åˆ†æ_${new Date().toLocaleDateString()}.xlsx`);
        
        showNotification('æ•°æ®å·²å¯¼å‡ºä¸ºExcelæ–‡ä»¶', 'success');
    }
    
    // å¯¼å‡ºæ•°æ®åˆ°CSV
    function exportToCSV() {
        // å‡†å¤‡CSVæ•°æ®
        let csvContent = "è§†é¢‘æ—¶é•¿(åˆ†é’Ÿ),ç‚¹èµæ•°,æœˆä»½,è¯„è®ºæ•°,å‘å¸ƒé‡\n";
        
        for (let i = 0; i < 12; i++) {
            const duration = safeDurationData[i] ? safeDurationData[i][0] : '';
            const likes = safeDurationData[i] ? safeDurationData[i][1] : '';
            const month = months[i];
            const comments = safeCommentsData[i] || 0;
            const videos = safeVideoCountData[i] || 0;
            
            csvContent += `${duration},${likes},${month},${comments},${videos}\n`;
        }
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        link.setAttribute('href', url);
        link.setAttribute('download', `Bç«™è§†é¢‘è¶‹åŠ¿åˆ†æ_${new Date().toLocaleDateString()}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('æ•°æ®å·²å¯¼å‡ºä¸ºCSVæ–‡ä»¶', 'success');
    }
    
    // æ˜¾ç¤ºé€šçŸ¥æç¤º
    function showNotification(message, type = 'info') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} position-fixed`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            animation: slideIn 0.3s ease-out;
        `;
        
        // æ·»åŠ å›¾æ ‡
        const iconMap = {
            success: 'check-circle',
            danger: 'exclamation-circle',
            warning: 'exclamation-triangle',
            info: 'info-circle'
        };
        
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-${iconMap[type]} me-3 fs-4"></i>
                <div>
                    <strong>${type === 'success' ? 'æˆåŠŸ' : type === 'danger' ? 'é”™è¯¯' : type === 'warning' ? 'è­¦å‘Š' : 'æç¤º'}</strong>: ${message}
                </div>
                <button type="button" class="btn-close ms-auto" aria-label="Close" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(notification);
        
        // è‡ªåŠ¨å…³é—­
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
</script>
{% endblock %}