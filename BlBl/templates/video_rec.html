{% extends 'base.html' %}
{% load static %}

{% block title %}智能推荐 - B站视频数据分析及可视化系统{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Microsoft YaHei', Arial, sans-serif;
        background-color: #f5f5f5;
        color: #333;
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 60px 20px;
        text-align: center;
        margin-bottom: 30px;
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: 15px;
    }
    
    .page-header .lead {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 20px;
    }
    
    .breadcrumb {
        background: transparent !important;
        justify-content: center;
    }
    
    .breadcrumb a {
        color: rgba(255,255,255,0.8) !important;
    }
    
    .breadcrumb-item.active {
        color: white !important;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }
    
    .recommendation-header {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .stats-bar {
        background: white;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .video-count {
        font-size: 16px;
        color: #666;
    }
    
    .sort-options select {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: white;
    }
    
    .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }
    
    .recommendation-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        border: none;
        height: 100%;
    }
    
    .recommendation-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .recommendation-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(45deg, #FF6B6B, #FF8E53);
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        z-index: 2;
    }
    
    .video-thumbnail {
        width: 100%;
        height: 160px;
        object-fit: cover;
        background: #f0f0f0;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .video-title {
        font-size: 16px;
        font-weight: 600;
        line-height: 1.4;
        margin-bottom: 10px;
        color: #2c3e50;
    }
    
    .video-title a {
        color: inherit;
        text-decoration: none;
    }
    
    .video-title a:hover {
        color: #667eea;
    }
    
    .video-meta {
        margin-bottom: 15px;
    }
    
    .video-category {
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .recommendation-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: #666;
        margin-bottom: 15px;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #666;
        background: white;
        border-radius: 15px;
        margin: 40px 0;
    }
    
    .empty-state .fas {
        font-size: 4rem;
        opacity: 0.3;
        margin-bottom: 20px;
    }
    
    .empty-state h4 {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: #999;
    }
    
    .atf-themes-btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        border: none;
    }
    
    .atf-themes-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    .algorithm-info {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .chart-title {
        color: #2c3e50;
        margin-bottom: 20px;
        font-weight: 600;
    }
    
    .insight-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .insight-card h5 {
        color: white;
        margin-bottom: 15px;
    }
    
    .insight-card p {
        opacity: 0.9;
        line-height: 1.6;
    }
    
    .list-unstyled li {
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    @media (max-width: 768px) {
        .video-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .page-header {
            padding: 40px 15px;
        }
        
        .page-header h1 {
            font-size: 2rem;
        }
        
        .stats-bar {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
    }
    .page-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 50px;
        padding-top: 30px;
        border-top: 1px solid #eaeaea;
    }
.nav-btn {
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .btn-prev {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-prev:hover {
        background-color: #5a6268;
        color: white;
        transform: translateX(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .btn-next {
        background-color: var(--accent-color);
        color: white;
    }
    
    .btn-next:hover {
        background-color: #3a66e0;
        color: white;
        transform: translateX(3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    .btn-next {
        background-color: blue;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <h1 class="display-4 mb-3">智能推荐系统</h1>
                <p class="lead">基于协同过滤算法的个性化视频推荐</p>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-center bg-transparent">
                        <li class="breadcrumb-item"><a href="{% url 'index' %}" class="text-white">首页</a></li>
                        <li class="breadcrumb-item active text-white" aria-current="page">智能推荐</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <section class="atf-section-padding">
        <div class="recommendation-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-3">
                        <i class="fas fa-robot me-3"></i>为您推荐
                    </h2>
                    <p class="mb-0">基于您的浏览历史和偏好，我们为您精心挑选了以下视频</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="text-center">
                        <!-- 修正：确保变量名与视图函数一致 -->
                        <h3 class="mb-1">{{ video_details|length|default:0 }}</h3>
                        <p class="mb-0">推荐视频</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 修正：添加空值检查，确保模板健壮性 -->
        {% if video_details and video_details|length > 0 %}
        <div class="stats-bar">
            <div class="video-count">
                共找到 <strong>{{ video_details|length }}</strong> 个推荐视频
            </div>
            <div class="sort-options">
                <select onchange="sortVideos(this.value)">
                    <option value="default">默认排序</option>
                    <option value="time">按时间排序</option>
                    <option value="category">按分类排序</option>
                    <option value="score">按评分排序</option> <!-- 新增 -->
                </select>
            </div>
        </div>

        <div class="row" id="videoGrid">
            {% for video in video_details %}
            <div class="col-lg-4 col-md-6 mb-4" data-video-id="{{ video.id|default:'' }}" 
                 data-category="{{ video.category|default:'' }}" 
                 data-score="{{ video.score|default:0 }}" 
                 data-time="{{ video.recommend|date:'U'|default:0 }}">
                <div class="recommendation-card card position-relative">
                    <div class="recommendation-badge">
                        <i class="fas fa-star me-1"></i>
                        {% if video.score %}评分: {{ video.score|floatformat:1 }}{% else %}推荐{% endif %}
                    </div>
                    <img src="{{ video.imgurl|default:'/static/assets/img/portfolio/default.jpg' }}"
                         class="video-thumbnail" 
                         alt="{{ video.videoname|default:'视频' }}"
                         onerror="this.src='{% static 'assets/img/portfolio/default.jpg' %}'">
                    <div class="card-body">
                        <h5 class="video-title">
                            <!-- 修正：增强URL安全性检查 -->
                            {% if video.id %}
                            <a href="{% url 'myapp_videodetail' video.id %}" class="text-decoration-none">
                                {{ video.videoname|default:"未命名视频"|truncatechars:50 }}
                            </a>
                            {% else %}
                            <span>{{ video.videoname|default:"未命名视频"|truncatechars:50 }}</span>
                            {% endif %}
                        </h5>
                        <p class="video-meta">
                            <span class="badge bg-primary">{{ video.category|default:"未分类" }}</span>
                        </p>
                        <div class="recommendation-stats">
                            <div class="stat-item">
                                <i class="fas fa-calendar"></i>
                                {{ video.recommend|date:"Y-m-d"|default:"未知时间" }}
                            </div>
                            {% if video.score %}
                            <div class="stat-item">
                                <i class="fas fa-chart-line"></i>
                                推荐度: {{ video.score|floatformat:1 }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            {% if video.id %}
                            <a href="{% url 'myapp_videodetail' video.id %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-play me-1"></i>查看详情
                            </a>
                            {% else %}
                            <button class="btn btn-secondary btn-sm" disabled>
                                <i class="fas fa-play me-1"></i>查看详情
                            </button>
                            {% endif %}
                            <small class="text-muted">
                                <i class="fas fa-magic me-1"></i>智能推荐
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- 空状态显示 -->
        <div class="empty-state">
            <i class="fas fa-robot"></i>
            <h4>暂无推荐内容</h4>
            <p class="text-muted mb-4">系统正在学习您的偏好，请先浏览一些视频来帮助我们了解您的兴趣</p>
            
            <!-- 调试信息（仅开发环境显示） -->
            {% if debug %}
            <div class="alert alert-info mt-3" role="alert">
                <h6>调试信息：</h6>
                <ul class="mb-0">
                    <li>用户ID: {{ user.id|default:"未登录" }}</li>
                    <li>视频数据: {{ video_details|default:"无数据" }}</li>
                    <li>数据条数: {{ video_details|length|default:0 }}</li>
                </ul>
            </div>
            {% endif %}
            
            <a href="{% url 'videolist' %}" class="atf-themes-btn mt-3">浏览视频</a>
        </div>
        {% endif %}

        <!-- Algorithm Explanation -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="algorithm-info">
                    <h4 class="chart-title">
                        <i class="fas fa-cogs me-2"></i>推荐算法原理
                    </h4>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center mb-4">
                                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <span class="h4 mb-0">1</span>
                                </div>
                                <h6 class="mt-3">数据收集</h6>
                                <p class="text-muted small">收集用户的浏览、点赞、收藏等行为数据</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center mb-4">
                                <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <span class="h4 mb-0">2</span>
                                </div>
                                <h6 class="mt-3">相似度计算</h6>
                                <p class="text-muted small">计算用户之间的行为相似度</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center mb-4">
                                <div class="bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <span class="h4 mb-0">3</span>
                                </div>
                                <h6 class="mt-3">推荐生成</h6>
                                <p class="text-muted small">基于相似用户的偏好生成推荐列表</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center mb-4">
                                <div class="bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <span class="h4 mb-0">4</span>
                                </div>
                                <h6 class="mt-3">持续优化</h6>
                                <p class="text-muted small">根据用户反馈不断优化推荐精度</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tips Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="algorithm-info">
                    <h5 class="chart-title">
                        <i class="fas fa-lightbulb me-2"></i>提升推荐效果的小贴士
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    多浏览不同类型的视频
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    对喜欢的视频进行点赞和收藏
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    积极参与评论互动
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    完善个人资料信息
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    保持活跃的使用习惯
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    关注感兴趣的内容创作者
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Insights -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="insight-card">
                    <h5><i class="fas fa-brain me-2"></i>智能推荐洞察</h5>
                    <p class="mb-0">
                        <strong>协同过滤算法</strong>通过分析用户行为模式，发现具有相似兴趣的用户群体，并基于这些相似用户的偏好为您推荐可能感兴趣的内容。
                        系统会持续学习您的反馈，不断优化推荐精度，为您提供更加个性化的视频推荐体验。
                    </p>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-5">
            <div class="col-12 text-center">
                <a href="{% url 'videolist' %}" class="atf-themes-btn me-3">
                    <i class="fas fa-video me-2"></i>浏览更多视频
                </a>
                <a href="" class="atf-themes-btn">
                    <i class="fas fa-user me-2"></i>个人中心
                </a>
            </div>
        </div>
    </section>
</div>
    <section class="page-navigation">
        <a href="{% url 'wordcloud' %}" class="nav-btn btn-prev">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            词云分析
        </a>
        <a href="{% url 'ai_chat_page' %}" class="nav-btn btn-next">
            AI助手
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
            </svg>
        </a>
    </section>
{% endblock %}

{% block extra_js %}
<script>
    // 增强排序功能
    function sortVideos(criteria) {
        const grid = document.getElementById('videoGrid');
        if (!grid) return;
        
        const cards = Array.from(grid.getElementsByClassName('col-lg-4'));
        
        cards.sort((a, b) => {
            if (criteria === 'time') {
                const timeA = parseInt(a.getAttribute('data-time'));
                const timeB = parseInt(b.getAttribute('data-time'));
                return timeB - timeA; // 最新在前
            } else if (criteria === 'category') {
                const categoryA = a.getAttribute('data-category') || '';
                const categoryB = b.getAttribute('data-category') || '';
                return categoryA.localeCompare(categoryB);
            } else if (criteria === 'score') {
                const scoreA = parseFloat(a.getAttribute('data-score')) || 0;
                const scoreB = parseFloat(b.getAttribute('data-score')) || 0;
                return scoreB - scoreA; // 高分在前
            }
            // 默认排序：按原始顺序或ID排序
            const idA = parseInt(a.getAttribute('data-video-id')) || 0;
            const idB = parseInt(b.getAttribute('data-video-id')) || 0;
            return idA - idB;
        });
        
        // 清空添加排序后的卡片
        cards.forEach(card => grid.appendChild(card));
    }
    
    // 图片错误处理
    document.addEventListener('DOMContentLoaded', function() {
        const images = document.querySelectorAll('.video-thumbnail');
        images.forEach(img => {
            // 如果图片URL为空，直接使用默认图片
            if (!img.src || img.src.includes('undefined') || img.src.endsWith('default ')) {
                img.src = '{% static "assets/img/portfolio/default.jpg" %}';
            }
            
            img.addEventListener('error', function() {
                this.src = '{% static "assets/img/portfolio/default.jpg" %}';
            });
        });
        
        // 添加点击统计（可选功能）
        const videoCards = document.querySelectorAll('.recommendation-card');
        videoCards.forEach(card => {
            card.addEventListener('click', function(e) {
                // 避免点击链接时重复统计
                if (!e.target.closest('a') && !e.target.closest('button')) {
                    const videoId = this.closest('[data-video-id]').getAttribute('data-video-id');
                    if (videoId) {
                        // 这里可以添加点击统计逻辑
                        console.log('视频点击:', videoId);
                    }
                }
            });
        });
    });
    
    // 新增：搜索过滤功能
    function filterVideos(searchTerm) {
        const videos = document.querySelectorAll('#videoGrid .col-lg-4');
        const searchLower = searchTerm.toLowerCase();
        
        videos.forEach(video => {
            const title = video.querySelector('.video-title').textContent.toLowerCase();
            const category = video.getAttribute('data-category').toLowerCase();
            const isVisible = title.includes(searchLower) || category.includes(searchLower);
            video.style.display = isVisible ? 'block' : 'none';
        });
    }

    function openVideo(videoId) {
        window.location.href = `/video/detail/${videoId}/`;
    }
</script>
{% endblock %}